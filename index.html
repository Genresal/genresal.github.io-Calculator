<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div class="container mt-3">
  <h2 class="p-3 text-center">Калькулятор норм КБЖУ</h2>
    <div class="row justify-content-center">
       <div class="col-lg-6 col-md-8 col-sm-10 col-12 mb-3">
        <div class="card h-100">
            <div class="card-header">
                <h3 class="card-title">Введите данные</h3>
            </div>
            <div class="card-body">
                <form id="form" class="needs-validation" novalidate>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" id="genderFemale" value=female checked>
                        <label class="form-check-label" for="flexRadioDefault1">Женщина</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" id="gendeMale" value=male>
                        <label class="form-check-label" for="flexRadioDefault2"> Мужчина</label>
                    </div>

                    <div class="form-floating mb-3 mt-3">
                        <input type="number" class="form-control" name="age" id="age" placeholder="Возраст" required min="16" max="80">
                        <label for="age">Возраст</label>
                        <div class="invalid-feedback">Пожалуйста, укажите корректный возраст.</div>
                    </div>
                    <div class="form-floating mb-3 mt-3">
                        <input type="number" class="form-control" name="height" id="height" placeholder="Рост" required min="140" max="220">
                        <label for="height">Рост</label>
                        <div class="invalid-feedback">Пожалуйста, укажите корректный рост.</div>
                    </div>
                    <div class="form-floating mb-3 mt-3">
                        <input type="number" class="form-control" name="weight" id="weight" placeholder="Вес" required min="35" max="180">
                        <label for="weight">Вес</label>
                        <div class="invalid-feedback">Пожалуйста, укажите корректный вес.</div>
                    </div>
                    <div class="form-floating mb-3 mt-3">
                        <select type="number" class="form-select" name="activityFactor" id="activityFactor">
                            <option selected value=1.25>Малоподвижный образ жизни</option>
                            <option value=1.3>2-3 легкие тренировки в неделю</option>
                            <option value=1.35>2-3 средние тренировки в неделю</option>
                            <option value=1.375>3 интенсивные тренировки в неделю</option>
                            <option value=1.4>4-5 интенсивных тренировок в неделю</option>
                            <option value=1.45>5+ интенсивных тренировок в неделю</option>
                        </select>
                        <label for="activityFactor">Активность</label>
                    </div>
                    <div class="form-floating mb-3 mt-3" id="breastFeeding">
                        <select type="number" class="form-select" name="breastFeeding">
                            <option selected value=0>Нет</option>
                            <option value=500>0-3 месяца</option>
                            <option value=450>3-6 месяцев</option>
                            <option value=350>6-9 месяцев</option>
                            <option value=250>9-12 месяцев</option>
                        </select>
                        <label for="breastFeeding">ГВ</label>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button type="submit" class="text-center btn btn-primary btn-lg">Рассчитать</button>
                    </div>
                </form>
            </div>
        </div>
    </div> 
    <!-- Result container-->
    <div id="resultContainer" class="col-lg-6 col-md-8 col-sm-10 col-12 mb-3" hidden=true>
        <div class="card h-100">
            <div class="card-header">
                <h3 class="card-title">Результат</h3>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td>BMI</td>
                            <td>
                                <p><strong id='bodyMassIndexView'></strong></p>
                            </td>
                        </tr>
                        <tr>
                            <td>Базовый калораж</td>
                            <td>
                                <p><strong id='basicCalories'></strong> ккал</p>
                            </td>
                        </tr>
                        <tr>
                            <td>С учетом физ активности</td>
                            <td>
                                <p><strong id='activityCalories'></strong> ккал</p>
                            </td>
                        </tr>
                        <tr>
                            <td>Дефицит</td>
                            <td>
                                <p><strong id='deficiteCalories'></strong> ккал</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            <!--<div class="table-responsive">-->
                <table class="table table-sm">
                <thead>
                    <tr>
                      <p>Нормы распределения белков, жиров, углеводов (в граммах.)</p>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="w-25">от</td>
                        <td class="w-25">рекомендуемая</td>
                        <td class="w-25">до</td>
                    </tr>
                    <tr>
                        <td id='minMacro.proteins'></td>
                        <td id='macro.proteins'></td>
                        <td id='maxMacro.proteins'></td>
                    </tr>
                    <tr>
                        <td id='minMacro.fats'></td>
                        <td id='macro.fats'></td>
                        <td id='maxMacro.fats'></td>
                    </tr>
                    <tr>
                        <td id='minMacro.carbs'></td>
                        <td id='macro.carbs'></td>
                        <td id='maxMacro.carbs'></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td id='sugar'></td>
                        <td></td>
                    </tr>
                </tbody>
                </table>
            <!--</div>-->
                </div>
        </div>
    </div>
</div>
</div>
</body>
</html>

<script>
//Enums
const Genders = { Female: 'female', Male: 'male'};
//Config and constants for calculation
const config = {
    cost: {
        proteins: 4,
        fats: 9,
        carbs: 4,
    },
    normalPercentage: {
        proteins: 0.28,
        fats: 0.38,
        carbs: 0.34,
        sugar: 0.1,
    },
    minPercentage: {
        proteins: 0.25,
        fats: 0.3,
        carbs: 0.3,
    },
    maxPercentage: {
        proteins: 0.3,
        fats: 0.4,
        carbs: 0.4,
    },
};
//BMI dictionary
var BmiDictionary = {
    0: "Ниже нормального веса",
    18.5: "Нормальный вес",
    25: "Избыточный вес",
    30: "Ожирение I степени",
    35: "Ожирение II степени",
    40: "Ожирение III степени"
};    
    
// Validaton
// Example starter JavaScript for disabling form submissions if there are invalid fields
(function () {
  'use strict'
  // Fetch all the forms we want to apply custom Bootstrap validation styles to
  var forms = document.querySelectorAll('.needs-validation')
  // Loop over them and prevent submission
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }

        form.classList.add('was-validated')
      }, false)
    })
})()
    
//Classes   
class CaloriesMacro {
    cost;
    percentage;
    proteins;
    carbs;
    fats;
    
    constructor(cost, percentage) {
        this.cost = cost;
        this.percentage = percentage;
    }
    
    calculate(calories) {
        this.proteins = calories * this.percentage.proteins / this.cost.proteins;
        this.carbs = calories * this.percentage.carbs / this.cost.carbs;
        this.fats = calories * this.percentage.fats / this.cost.fats;
    }
}
    
class Calories {
    config;
    bodyMassIndex;
    bodyMassIndexView;
    caloriesReduction;
    basicCalories;
    activityCalories;
    deficite;
    deficiteCalories;
    macro = new CaloriesMacro(config.cost, config.normalPercentage);
    minMacro = new CaloriesMacro(config.cost, config.minPercentage);
    maxMacro = new CaloriesMacro(config.cost, config.maxPercentage);
    sugar;
    
    constructor(config) {
        this.config = config;
    }
    
    calculate(userData) {
    this.bodyMassIndex = userData.weight/((userData.height/100) ** 2);
    var maxKey = 0;
    for (var key in BmiDictionary) {
        if (maxKey <= 0 || key < this.bodyMassIndex) {
            maxKey = Math.max(maxKey, key);
        }
    }
    this.bodyMassIndexView = this.bodyMassIndex.toFixed(1) + " - " +  BmiDictionary[maxKey]    
        
    this.caloriesReduction = 1-(this.bodyMassIndex - 20)/100
        if(this.caloriesReduction > 1)
            this.caloriesReduction = 1
        if(this.caloriesReduction < 0.75)
            this.caloriesReduction = 0.75
        
        userData.gender == Genders.Female ? 
            this.basicCalories = (9.99*userData.weight + 6.25*userData.height - 4.92*userData.age - 161) *this.caloriesReduction : 
            this.basicCalories = (9.99*userData.weight + 6.25*userData.height - 4.92*userData.age + 5) *this.caloriesReduction;
        
        this.activityCalories = this.basicCalories * userData.activityFactor + userData.breastFeeding;
        this.deficite = 0.85;
        this.deficiteCalories = this.activityCalories * this.deficite;
        
        this.macro.calculate(this.deficiteCalories);
        this.minMacro.calculate(this.deficiteCalories);
        this.maxMacro.calculate(this.deficiteCalories);
        
        this.sugar = this.deficiteCalories * config.normalPercentage.sugar / config.cost.carbs;
  }
}
    
//Hidding Breast Feeding input if male gender selected
document.querySelectorAll('[name="gender"]').forEach(x => 
  x.addEventListener("click", function(){
    var val = document.querySelector('input[name="gender"]:checked').value
    var breastFeedingElement = document.getElementById("breastFeeding");
    if (val == Genders.Female){
        breastFeedingElement.hidden = false;
    }
    else {
        breastFeedingElement.value = 0
        breastFeedingElement.hidden = true;
    }
}));

//Submit Form
document.querySelector('form').addEventListener('submit', (e) => {
    e.preventDefault()
    const data = Object.fromEntries(new FormData(e.target).entries());
    console.log(data)
    var result = new Calories(config);
    result.calculate(data);
    console.log(result)
    
    for (const [key, val] of Object.entries(result)) {
        console.log(key)
        if(typeof val === 'object'){
            for (const [k, v] of Object.entries(val)) {
                var obj = document.getElementById(key+'.'+k)
                if(obj){
                    obj.innerText = Math.round(v);
                }
            }
        }
        
       if(typeof val === 'string'){
            var obj = document.getElementById(key)
        if(obj){
            obj.innerText = val;
            continue;
        }
        }
        
        var obj = document.getElementById(key)
        if(obj){
            obj.innerText = Math.round(val);
        }
    }
    
    var resultContainer = document.getElementById("resultContainer");
    resultContainer.hidden = false;

});
</script>
